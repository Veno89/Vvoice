var c=Object.defineProperty;var l=(a,e,t)=>e in a?c(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var s=(a,e,t)=>l(a,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&n(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();class d{constructor(e,t){s(this,"ws",null);s(this,"url");s(this,"clientId");s(this,"protocolVersion","1.0.0");s(this,"reconnectAttempts",0);s(this,"maxReconnectAttempts",10);s(this,"initialReconnectDelay",1e3);s(this,"maxReconnectDelay",3e4);s(this,"forcedClose",!1);s(this,"reconnectTimer",null);s(this,"onOpen");s(this,"onClose");s(this,"onError");s(this,"onMessage");this.url=e,this.clientId=t}connect(){this.forcedClose=!1,this.reconnectTimer&&clearTimeout(this.reconnectTimer),console.log(`[Signaling] Connecting to ${this.url}`),this.ws=new WebSocket(this.url),this.ws.onopen=()=>{var e;console.log("[Signaling] Connected"),this.reconnectAttempts=0,this.sendHello(),(e=this.onOpen)==null||e.call(this)},this.ws.onclose=()=>{var e;console.log("[Signaling] Disconnected"),(e=this.onClose)==null||e.call(this),this.forcedClose||this.scheduleReconnect()},this.ws.onerror=e=>{var t;console.error("[Signaling] Error",e),(t=this.onError)==null||t.call(this,e)},this.ws.onmessage=e=>{var t;try{const n=JSON.parse(e.data);(t=this.onMessage)==null||t.call(this,n)}catch{console.error("[Signaling] Failed to parse message",e.data)}}}disconnect(){var e;this.forcedClose=!0,this.reconnectTimer&&clearTimeout(this.reconnectTimer),(e=this.ws)==null||e.close()}scheduleReconnect(){if(this.reconnectAttempts>=this.maxReconnectAttempts){console.error("[Signaling] Max reconnect attempts reached");return}const e=Math.min(this.initialReconnectDelay*Math.pow(2,this.reconnectAttempts),this.maxReconnectDelay);console.log(`[Signaling] Reconnecting in ${e}ms...`),this.reconnectTimer=window.setTimeout(()=>{this.reconnectAttempts++,this.connect()},e)}send(e){this.ws&&this.ws.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify(e)):console.warn("[Signaling] Cannot send, socket not open")}sendHello(){const e={type:"client_hello",protocolVersion:this.protocolVersion,clientId:this.clientId};this.send(e)}joinRoom(e,t){const n={type:"join_room",roomId:e,displayName:t};this.send(n)}sendOffer(e,t){const n={type:"webrtc_offer",toPeerId:e,sdp:JSON.stringify(t)};this.send(n)}sendAnswer(e,t){const n={type:"webrtc_answer",toPeerId:e,sdp:JSON.stringify(t)};this.send(n)}sendCandidate(e,t){const n={type:"webrtc_ice_candidate",toPeerId:e,candidate:JSON.stringify(t)};this.send(n)}setMute(e,t){const n={type:"set_mute",roomId:e,muted:t};this.send(n)}}class h{constructor(e){s(this,"signaling");s(this,"localStream",null);s(this,"peers",new Map);s(this,"iceServers",[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]);s(this,"onRemoteStream");s(this,"onPeerLeft");this.signaling=e,this.setupDeviceListeners()}setupDeviceListeners(){navigator.mediaDevices.addEventListener("devicechange",async()=>{await this.handleDeviceChange()})}async handleDeviceChange(){if(!this.localStream)return;const e=this.localStream.getAudioTracks();if(e.length!==0)try{const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:48e3},video:!1}),n=t.getAudioTracks()[0];n&&(await this.replaceAudioTrack(n),e.forEach(i=>i.stop()),this.localStream=t)}catch(t){console.error("[RTC] Device swap failed",t)}}async replaceAudioTrack(e){for(const t of this.peers.values()){const i=t.pc.getSenders().find(o=>{var r;return((r=o.track)==null?void 0:r.kind)==="audio"});if(i)try{await i.replaceTrack(e)}catch(o){console.error(`[RTC] Failed to replace track for ${t.peerId}`,o)}}}async getLocalAudio(){if(this.localStream)return this.localStream;try{return this.localStream=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:48e3},video:!1}),this.localStream}catch(e){throw console.error("Failed to get media",e),e}}async handleMessage(e){switch(e.type){case"room_joined":for(const t of e.participants)t.peerId!==e.selfPeerId&&await this.initiateConnection(t.peerId);break;case"participant_joined":break;case"participant_left":this.closePeer(e.peerId);break;case"webrtc_offer":await this.handleOffer(e.fromPeerId,JSON.parse(e.sdp));break;case"webrtc_answer":await this.handleAnswer(e.fromPeerId,JSON.parse(e.sdp));break;case"webrtc_ice_candidate":await this.handleCandidate(e.fromPeerId,JSON.parse(e.candidate));break}}createPeerConnection(e){if(this.peers.has(e))return this.peers.get(e).pc;const t=new RTCPeerConnection({iceServers:this.iceServers,iceCandidatePoolSize:10,bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});return t.onicecandidate=n=>{n.candidate&&this.signaling.sendCandidate(e,n.candidate)},t.ontrack=n=>{var i;n.streams&&n.streams[0]&&((i=this.onRemoteStream)==null||i.call(this,e,n.streams[0]))},this.localStream&&this.localStream.getTracks().forEach(n=>{t.addTrack(n,this.localStream)}),this.peers.set(e,{pc:t,peerId:e}),t}async initiateConnection(e){const t=this.createPeerConnection(e),n=await t.createOffer();n.sdp&&(n.sdp=this.mungeSDP(n.sdp)),await t.setLocalDescription(n),this.signaling.sendOffer(e,n)}async handleOffer(e,t){const n=this.createPeerConnection(e);await n.setRemoteDescription(new RTCSessionDescription(t));const i=await n.createAnswer();i.sdp&&(i.sdp=this.mungeSDP(i.sdp)),await n.setLocalDescription(i),this.signaling.sendAnswer(e,i)}async handleAnswer(e,t){const n=this.peers.get(e);n&&await n.pc.setRemoteDescription(new RTCSessionDescription(t))}async handleCandidate(e,t){const n=this.peers.get(e);if(n)try{await n.pc.addIceCandidate(new RTCIceCandidate(t))}catch(i){console.error("[RTC] Failed to add candidate",i)}else console.warn("[RTC] Got candidate for unknown peer",e)}closePeer(e){var n;const t=this.peers.get(e);t&&(t.pc.close(),this.peers.delete(e),(n=this.onPeerLeft)==null||n.call(this,e))}setMute(e){this.localStream&&this.localStream.getAudioTracks().forEach(t=>{t.enabled=!e})}cleanup(){var e;(e=this.localStream)==null||e.getTracks().forEach(t=>t.stop()),this.peers.forEach(t=>t.pc.close()),this.peers.clear()}mungeSDP(e){const t=e.split(`\r
`);let n=null;for(const o of t){const r=o.match(/a=rtpmap:(\d+) opus\/48000\/2/i);if(r){n=r[1];break}}if(!n)return e;const i="minptime=10;useinbandfec=1;usedtx=1;maxaveragebitrate=32000";return t.map(o=>o.startsWith(`a=fmtp:${n} `)?`${o};${i}`:o).join(`\r
`)}}class u{constructor(){s(this,"signaling");s(this,"rtc");s(this,"clientId");s(this,"btnConnect");s(this,"btnJoin");s(this,"btnMute");s(this,"inputRoom");s(this,"inputName");s(this,"statusDiv");s(this,"peerListDiv");s(this,"audioContainer");s(this,"currentRoom","");s(this,"isMuted",!1);this.clientId="web-"+Math.random().toString(36).substr(2,9),this.signaling=new d("ws://localhost:3000/ws",this.clientId),this.rtc=new h(this.signaling),this.btnConnect=document.getElementById("btn-connect"),this.btnJoin=document.getElementById("btn-join"),this.btnMute=document.getElementById("btn-mute"),this.inputRoom=document.getElementById("input-room"),this.inputName=document.getElementById("input-name"),this.statusDiv=document.getElementById("status"),this.peerListDiv=document.getElementById("peer-list"),this.audioContainer=document.getElementById("audio-container"),this.setupListeners()}setupListeners(){this.btnConnect.onclick=()=>{this.signaling.connect(),this.setStatus("Connecting...")},this.btnJoin.onclick=async()=>{const e=this.inputRoom.value,t=this.inputName.value;if(!e||!t)return alert("Enter room and name");this.currentRoom=e;try{await this.rtc.getLocalAudio(),this.signaling.joinRoom(e,t),this.setStatus(`Joined ${e} as ${t}`),this.btnJoin.disabled=!0,this.btnMute.disabled=!1}catch(n){this.setStatus("Error getting audio: "+n)}},this.btnMute.onclick=()=>{this.isMuted=!this.isMuted,this.rtc.setMute(this.isMuted),this.signaling.setMute(this.currentRoom,this.isMuted),this.btnMute.textContent=this.isMuted?"Unmute":"Mute"},this.signaling.onOpen=()=>{this.setStatus("Connected to Signaling Server"),this.btnConnect.disabled=!0,this.btnJoin.disabled=!1},this.signaling.onClose=()=>{this.setStatus("Disconnected"),this.btnConnect.disabled=!1,this.btnJoin.disabled=!0},this.signaling.onMessage=e=>{this.rtc.handleMessage(e),e.type==="room_joined"?this.renderPeers(e.participants):e.type==="participant_joined"?this.addPeerLog(`${e.displayName} joined`):e.type==="participant_left"?this.addPeerLog(`Peer ${e.peerId} left`):e.type==="participant_muted"&&this.addPeerLog(`Peer ${e.peerId} ${e.muted?"muted":"unmuted"}`)},this.rtc.onRemoteStream=(e,t)=>{let n=document.getElementById(`audio-${e}`);n||(n=document.createElement("audio"),n.id=`audio-${e}`,n.autoplay=!0,n.controls=!0,this.audioContainer.appendChild(n)),n.srcObject=t,n.play().catch(i=>console.error("[UI] Autoplay blocked:",i))},this.rtc.onPeerLeft=e=>{const t=document.getElementById(`audio-${e}`);t&&t.remove()}}setStatus(e){this.statusDiv.textContent=`Status: ${e}`}renderPeers(e){this.peerListDiv.innerHTML="<h3>Participants:</h3>"+e.map(t=>`<div>${t.displayName} (${t.peerId})</div>`).join("")}addPeerLog(e){const t=document.createElement("div");t.textContent=e,this.peerListDiv.appendChild(t)}}document.addEventListener("DOMContentLoaded",()=>{new u});
