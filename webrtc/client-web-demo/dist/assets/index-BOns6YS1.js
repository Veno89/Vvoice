var b=Object.defineProperty;var k=(t,e,n)=>e in t?b(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var r=(t,e,n)=>k(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function n(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(i){if(i.ep)return;i.ep=!0;const s=n(i);fetch(i.href,s)}})();class C{constructor(e){r(this,"options");r(this,"peers",new Map);r(this,"localStream");this.options=e}async setupLocalAudio(e){const n={audio:{deviceId:e?{exact:e}:void 0,echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}};return this.localStream=await navigator.mediaDevices.getUserMedia(n),this.localStream}setMuted(e){var n;(n=this.localStream)==null||n.getAudioTracks().forEach(o=>{o.enabled=!e})}async ensurePeer(e){const n=this.peers.get(e);if(n)return n;const o=new RTCPeerConnection({iceServers:this.options.iceServers});return o.onicecandidate=i=>{i.candidate&&this.options.onIceCandidate(e,i.candidate.candidate)},o.onconnectionstatechange=()=>{this.options.onConnectionState(e,o.connectionState)},o.ontrack=i=>{const[s]=i.streams;s&&this.options.onRemoteTrack(e,s)},this.localStream&&this.localStream.getTracks().forEach(i=>{o.addTrack(i,this.localStream)}),this.peers.set(e,o),o}async createOffer(e){const n=await this.ensurePeer(e),o=await n.createOffer();await n.setLocalDescription(o),this.options.onOffer(e,o.sdp??"")}async handleOffer(e,n){const o=await this.ensurePeer(e);await o.setRemoteDescription({type:"offer",sdp:n});const i=await o.createAnswer();await o.setLocalDescription(i),this.options.onAnswer(e,i.sdp??"")}async handleAnswer(e,n){await(await this.ensurePeer(e)).setRemoteDescription({type:"answer",sdp:n})}async handleIceCandidate(e,n){await(await this.ensurePeer(e)).addIceCandidate({candidate:n})}removePeer(e){const n=this.peers.get(e);n&&(n.close(),this.peers.delete(e))}closeAll(){for(const[e]of this.peers)this.removePeer(e)}}const P="1.0.0";class T{constructor(e){r(this,"options");r(this,"ws");r(this,"reconnectTimer");r(this,"pingTimer");r(this,"reconnectAttempts",0);r(this,"token");r(this,"username","");r(this,"session");this.options=e}async connect(e,n){this.username=e,this.session=n;const o=await fetch(`${this.options.authBaseUrl}/auth/dev`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:e})});if(!o.ok)throw new Error(`Failed to auth user (${o.status})`);const i=await o.json();this.token=i.token,this.openSocket()}send(e){var n;((n=this.ws)==null?void 0:n.readyState)===WebSocket.OPEN&&this.ws.send(JSON.stringify(e))}joinRoom(e,n){this.session={roomId:e,displayName:n},this.send({type:"join_room",roomId:e,displayName:n})}leaveRoom(e){var n;this.send({type:"leave_room",roomId:e}),((n=this.session)==null?void 0:n.roomId)===e&&(this.session=void 0)}disconnect(){var e;this.clearTimers(),(e=this.ws)==null||e.close()}openSocket(){this.options.onStatus("connecting");const e=new WebSocket(this.options.wsUrl);this.ws=e,e.addEventListener("open",()=>{this.options.onStatus("connected"),this.reconnectAttempts=0,this.send({type:"client_hello",protocolVersion:P,clientId:this.options.clientId,authToken:this.token}),this.session&&this.joinRoom(this.session.roomId,this.session.displayName),this.pingTimer=window.setInterval(()=>{this.send({type:"ping"})},1e4)}),e.addEventListener("message",n=>{try{const o=JSON.parse(String(n.data));this.options.onMessage(o)}catch{this.options.onStatus("invalid-message")}}),e.addEventListener("close",()=>{this.options.onStatus("disconnected"),this.scheduleReconnect()}),e.addEventListener("error",()=>{this.options.onStatus("error")})}scheduleReconnect(){this.clearPing();const e=Math.min(2e4,1e3*2**this.reconnectAttempts);this.reconnectAttempts+=1,this.reconnectTimer=window.setTimeout(()=>{this.openSocket()},e)}clearPing(){this.pingTimer&&(window.clearInterval(this.pingTimer),this.pingTimer=void 0)}clearTimers(){this.clearPing(),this.reconnectTimer&&(window.clearTimeout(this.reconnectTimer),this.reconnectTimer=void 0)}}const d=new Map;let v="",u="",p=!1;const $=h("status"),g=h("participants"),I=h("log"),S=h("localAudio"),O=h("remoteAudioContainer"),m=new T({wsUrl:y("wsUrl").value,authBaseUrl:y("apiBaseUrl").value,clientId:crypto.randomUUID(),onMessage:_,onStatus:t=>w(`signal:${t}`)}),l=new C({iceServers:[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:localhost:3478"],username:"dev",credential:"dev"}],onIceCandidate:(t,e)=>{m.send({type:"webrtc_ice_candidate",toPeerId:t,candidate:e})},onOffer:(t,e)=>{m.send({type:"webrtc_offer",toPeerId:t,sdp:e})},onAnswer:(t,e)=>{m.send({type:"webrtc_answer",toPeerId:t,sdp:e})},onConnectionState:(t,e)=>{c(`Peer ${t} connection state: ${e}`)},onRemoteTrack:(t,e)=>{let n=document.getElementById(`remote-${t}`);n||(n=document.createElement("audio"),n.id=`remote-${t}`,n.autoplay=!0,n.controls=!0,O.appendChild(n)),n.srcObject=e}});function L(){var t,e,n;(t=document.getElementById("joinForm"))==null||t.addEventListener("submit",async o=>{o.preventDefault();const i=y("username").value.trim();u=y("roomId").value.trim();const s=document.getElementById("micDevice").value;if(!i||!u){c("Username and room are required.");return}w("connecting");try{const a=await l.setupLocalAudio(s||void 0);S.srcObject=a,S.muted=!0,await m.connect(i,{roomId:u,displayName:i}),await E()}catch(a){c(`Failed to join: ${a instanceof Error?a.message:"unknown error"}`),w("failed")}}),(e=document.getElementById("leaveBtn"))==null||e.addEventListener("click",()=>{u&&m.leaveRoom(u),l.closeAll(),d.clear(),f(),w("disconnected")}),(n=document.getElementById("muteBtn"))==null||n.addEventListener("click",()=>{p=!p,l.setMuted(p),u&&m.send({type:"set_mute",roomId:u,muted:p});const o=document.getElementById("muteBtn");o.textContent=p?"Unmute":"Mute"}),E().catch(()=>c("Could not enumerate mics."))}async function _(t){switch(t.type){case"room_joined":{v=t.selfPeerId,d.clear();for(const e of t.participants)d.set(e.peerId,e),await l.createOffer(e.peerId);f(),w("connected"),c(`Joined room ${t.roomId} as ${v}`);break}case"participant_joined":{d.set(t.peerId,{peerId:t.peerId,userId:"unknown",displayName:t.displayName,muted:t.muted}),f(),c(`${t.displayName} joined.`);break}case"participant_left":{d.delete(t.peerId),l.removePeer(t.peerId);const e=document.getElementById(`remote-${t.peerId}`);e==null||e.remove(),f(),c(`Peer ${t.peerId} left.`);break}case"participant_muted":{const e=d.get(t.peerId);e&&(e.muted=t.muted,d.set(t.peerId,e),f());break}case"webrtc_offer":await l.handleOffer(t.fromPeerId,t.sdp);break;case"webrtc_answer":await l.handleAnswer(t.fromPeerId,t.sdp);break;case"webrtc_ice_candidate":await l.handleIceCandidate(t.fromPeerId,t.candidate);break;case"server_notice":c(`Notice: ${t.message}`);break;case"signal_error":c(`Signal error (${t.code}): ${t.message}`);break;case"pong":break;default:c("Unhandled server message")}}async function E(){const t=await navigator.mediaDevices.enumerateDevices(),e=document.getElementById("micDevice"),n=t.filter(o=>o.kind==="audioinput");e.innerHTML="",n.forEach(o=>{const i=document.createElement("option");i.value=o.deviceId,i.textContent=o.label||`Microphone ${e.options.length+1}`,e.appendChild(i)})}function f(){g.innerHTML="";const t=document.createElement("li");t.textContent=`You (${v||"pending"}) ${p?"[muted]":""}`,g.appendChild(t);for(const e of d.values()){const n=document.createElement("li");n.textContent=`${e.displayName} (${e.peerId.slice(0,8)}) ${e.muted?"[muted]":""}`,g.appendChild(n)}}function w(t){$.textContent=t}function c(t){const e=new Date().toLocaleTimeString();I.textContent=`[${e}] ${t}
${I.textContent}`}function h(t){const e=document.getElementById(t);if(!e)throw new Error(`Missing required element: #${t}`);return e}function y(t){return h(t)}L();
